# Simple workflow for running puppeter tests on pull requests
name: Puppeteer Tests

on:
  pull_request:
    branches: [main]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets the GITHUB_TOKEN permissions to allow deployment to GitHub Pages
permissions:
  contents: write
  pull-requests: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
      - name: Configure Git Safe Directory
        run: |
          git config --global --add safe.directory /github/workspace
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      - name: Install Puppeteer Chromium
        run: npx puppeteer install
      - name: build
        run: npm run build
      - name: Start server
        run: npm start &
      - name: Run Tests
        run: npm test
      - name: Comment Webpage Screenshot
        uses: opengisch/comment-pr-with-images@upload_only
        with:
          # required: Comma seperated list of files to upload.
          images: "Puppet/images/main.png"
          # optional: The action will create a new branch and
          # upload the screenshots to that branch.
          upload_to: imgur #github_branch # Or, imgur
